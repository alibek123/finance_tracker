<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личные финансы</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5e72e4;
            --success-color: #2dce89;
            --danger-color: #f5365c;
            --warning-color: #fb6340;
            --info-color: #11cdef;
            --dark: #32325d;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #32325d;
            --text-secondary: #8898aa;
            --border-color: #e9ecef;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a4a8b4;
            --border-color: #2d3348;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .navbar {
            background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%);
            box-shadow: 0 4px 6px rgba(50, 50, 93, .11), 0 1px 3px rgba(0, 0, 0, .08);
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
        }

        .navbar-date-picker {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
            z-index: 20;
            margin: 0;
            padding: 0;
            border: none;
        }

        .navbar-date-container {
            position: relative;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s;
            min-width: 160px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-date-container:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .navbar-date-container:active {
            transform: scale(0.98);
        }


        .navbar-date-container.not-today {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .navbar-date-container.not-today::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border-radius: 0.5rem;
            opacity: 0.3;
            z-index: -1;
        }

        .card {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 0;
            box-shadow: 0 4px 6px rgba(50, 50, 93, .11), 0 1px 3px rgba(0, 0, 0, .08);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, .1), 0 3px 6px rgba(0, 0, 0, .08);
        }

        .stat-card {
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #4c63d2;
            border-color: #4c63d2;
        }

        .transaction-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .transaction-item:hover {
            background-color: var(--bg-primary);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .amount-expense {
            color: var(--danger-color);
            font-weight: 600;
        }

        .amount-income {
            color: var(--success-color);
            font-weight: 600;
        }

        .amount-transfer {
            color: var(--info-color);
            font-weight: 600;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 1rem;
        }

        .budget-progress {
            height: 8px;
            border-radius: 4px;
            background-color: var(--border-color);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .budget-progress-bar {
            height: 100%;
            transition: width 0.6s ease;
        }

        .goal-progress {
            height: 12px;
            border-radius: 6px;
            background-color: var(--border-color);
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            transition: width 0.6s ease;
        }

        .tab-content {
            padding-top: 2rem;
        }

        .floating-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-header {
            background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%);
            color: white;
            border-bottom: 0;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .search-box {
            position: relative;
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-box input {
            padding-left: 38px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .search-box input:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        .tag-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tag-badge:hover {
            transform: scale(1.05);
        }

        .tag-badge.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .recurring-badge {
            background-color: var(--warning-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        .form-control, .form-select {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        .nav-tabs {
            border-bottom-color: var(--border-color);
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border-color: transparent;
        }

        .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--bg-secondary);
            border-color: var(--border-color) var(--border-color) var(--bg-secondary);
        }

        @media (max-width: 768px) {
            .floating-btn {
                bottom: 1rem;
                right: 1rem;
            }

            .stat-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Загрузка...</span>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-wallet2"></i> Мои финансы
        </a>
        <div class="ms-auto d-flex align-items-center">
            <button class="btn btn-link text-white me-3" onclick="toggleTheme()" title="Сменить тему">
                <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
            </button>
            <div class="navbar-text text-white me-3 navbar-date-container"
                 id="navbarDate"
                 title="Изменить дату"
                 onclick="openDatePicker()">
                <i class="bi bi-calendar3"></i>
                <span id="currentDate"></span>
                <input type="date"
                       id="hiddenDatePicker"
                       onchange="changeSelectedDate(this.value)"
                       style="position: absolute; opacity: 0; pointer-events: none; z-index: -1;">
            </div>
            <button class="btn btn-link text-white p-1" onclick="setTodayDate()" title="Вернуться к сегодняшней дате">
                <i class="bi bi-house"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <!-- Stats Row -->
    <div class="row" id="statsRow">
        <!-- Stats will be loaded here -->
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button">
                <i class="bi bi-speedometer2"></i> Обзор
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions"
                    type="button">
                <i class="bi bi-list-ul"></i> Транзакции
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="budgets-tab" data-bs-toggle="tab" data-bs-target="#budgets" type="button">
                <i class="bi bi-piggy-bank"></i> Бюджеты
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals" type="button">
                <i class="bi bi-bullseye"></i> Цели
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="recurring-tab" data-bs-toggle="tab" data-bs-target="#recurring" type="button">
                <i class="bi bi-arrow-repeat"></i> Повторяющиеся
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
                <i class="bi bi-graph-up"></i> Аналитика
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                <i class="bi bi-gear"></i> Настройки
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="mainTabContent">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Расходы за последние 30 дней</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Топ категорий</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Последние транзакции</h5>
                        </div>
                        <div class="card-body" id="recentTransactions">
                            <!-- Recent transactions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div class="tab-pane fade" id="transactions" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-0">Все транзакции</h5>
                        </div>
                        <div class="col-md-8">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="search-box">
                                        <i class="bi bi-search search-icon"></i>
                                        <input type="text" class="form-control" id="transactionSearch"
                                               placeholder="Поиск...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="filterStartDate">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="filterEndDate">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="transactionFilter">
                                        <option value="">Все типы</option>
                                        <option value="expense">Расходы</option>
                                        <option value="income">Доходы</option>
                                        <option value="transfer">Переводы</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div id="selectedTags">
                                <!-- Selected tags will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="allTransactions">
                    <!-- All transactions will be loaded here -->
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-sm btn-secondary" onclick="exportData('csv')">
                            <i class="bi bi-download"></i> Экспорт CSV
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="exportData('json')">
                            <i class="bi bi-download"></i> Экспорт JSON
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="showImportModal()">
                            <i class="bi bi-upload"></i> Импорт данных
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budgets Tab -->
        <div class="tab-pane fade" id="budgets" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Бюджеты</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddBudgetModal()">
                    <i class="bi bi-plus-circle"></i> Добавить бюджет
                </button>
            </div>
            <div class="row" id="budgetsList">
                <!-- Budgets will be loaded here -->
            </div>
        </div>

        <!-- Goals Tab -->
        <div class="tab-pane fade" id="goals" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Цели накопления</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddGoalModal()">
                    <i class="bi bi-plus-circle"></i> Добавить цель
                </button>
            </div>
            <div class="row" id="goalsList">
                <!-- Goals will be loaded here -->
            </div>
        </div>

        <!-- Recurring Tab -->
        <div class="tab-pane fade" id="recurring" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Повторяющиеся транзакции</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddRecurringModal()">
                    <i class="bi bi-plus-circle"></i> Добавить
                </button>
            </div>
            <div class="row" id="recurringList">
                <!-- Recurring transactions will be loaded here -->
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Тренд доходов и расходов</h5>
                            <select class="form-select form-select-sm w-auto" id="trendPeriod" onchange="loadTrends()">
                                <option value="daily">По дням</option>
                                <option value="weekly">По неделям</option>
                                <option value="monthly" selected>По месяцам</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Прогноз расходов</h5>
                        </div>
                        <div class="card-body" id="forecastContent">
                            <!-- Forecast will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Сравнение по месяцам</h5>
                        </div>
                        <div class="card-body" id="monthlyComparisonContent">
                            <!-- Monthly comparison will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Распределение по счетам</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="accountBalanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Структура расходов по категориям</h5>
                        </div>
                        <div class="card-body" id="categoryAnalytics">
                            <!-- Category analytics will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Топ расходов за месяц</h5>
                        </div>
                        <div class="card-body" id="topExpensesContent">
                            <!-- Top expenses will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Счета</h5>
                        </div>
                        <div class="card-body" id="accountsList">
                            <!-- Accounts will be loaded here -->
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-primary" onclick="showAddAccountModal()">
                                <i class="bi bi-plus-circle"></i> Добавить счет
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Категории</h5>
                        </div>
                        <div class="card-body" id="categoriesList">
                            <!-- Categories will be loaded here -->
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-primary" onclick="showAddCategoryModal()">
                                <i class="bi bi-plus-circle"></i> Добавить категорию
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Теги</h5>
                        </div>
                        <div class="card-body" id="tagsList">
                            <!-- Tags will be loaded here -->
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-primary" onclick="showAddTagModal()">
                                <i class="bi bi-plus-circle"></i> Добавить тег
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Add Transaction Button -->
<button class="btn btn-primary btn-lg rounded-circle floating-btn" onclick="showAddTransactionModal()">
    <i class="bi bi-plus-lg"></i>
</button>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span id="successMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span id="errorMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить транзакцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="transaction_type" id="typeExpense"
                                   value="expense" checked>
                            <label class="btn btn-outline-danger" for="typeExpense">Расход</label>

                            <input type="radio" class="btn-check" name="transaction_type" id="typeIncome"
                                   value="income">
                            <label class="btn btn-outline-success" for="typeIncome">Доход</label>

                            <input type="radio" class="btn-check" name="transaction_type" id="typeTransfer"
                                   value="transfer">
                            <label class="btn btn-outline-info" for="typeTransfer">Перевод</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="amount" required min="0" step="0.01">
                    </div>

                    <div class="mb-3" id="accountFromGroup">
                        <label class="form-label">Со счета</label>
                        <select class="form-select" id="accountFrom" required>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="accountToGroup">
                        <label class="form-label">На счет</label>
                        <select class="form-select" id="accountTo">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3" id="categoryGroup">
                        <label class="form-label">Категория</label>
                        <select class="form-select" id="category" required>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <input type="text" class="form-control" id="description">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Теги</label>
                        <div id="transactionTags">
                            <!-- Tags will be loaded here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Дата</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addTransaction()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Импорт данных</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importForm">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Выберите файл (CSV или JSON)</label>
                        <input type="file" class="form-control" id="importFile" accept=".csv,.json" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Формат CSV: date, type, amount, description, notes, category,
                        account_from, account_to, tags
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="importData()">Импортировать</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить счет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="accountName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="accountType" required>
                            <option value="cash">Наличные</option>
                            <option value="debit_card">Дебетовая карта</option>
                            <option value="credit_card">Кредитная карта</option>
                            <option value="savings">Сберегательный счет</option>
                            <option value="investment">Инвестиционный счет</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Начальный баланс</label>
                        <input type="number" class="form-control" id="initialBalance" required min="0" step="0.01"
                               value="0">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Валюта</label>
                        <select class="form-select" id="accountCurrency">
                            <option value="KZT">KZT - Тенге</option>
                            <option value="USD">USD - Доллар</option>
                            <option value="EUR">EUR - Евро</option>
                            <option value="RUB">RUB - Рубль</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Иконка</label>
                        <input type="text" class="form-control" id="accountIcon" placeholder="💳" maxlength="2">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Цвет</label>
                        <input type="color" class="form-control form-control-color" id="accountColor" value="#5e72e4">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addAccount()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить категорию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="categoryType" required>
                            <option value="expense">Расход</option>
                            <option value="income">Доход</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Родительская категория</label>
                        <select class="form-select" id="parentCategory">
                            <option value="">Нет (основная категория)</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Иконка</label>
                        <input type="text" class="form-control" id="categoryIcon" placeholder="📁" maxlength="2">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Цвет</label>
                        <input type="color" class="form-control form-control-color" id="categoryColor" value="#5e72e4">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Budget Modal -->
<div class="modal fade" id="addBudgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить бюджет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBudgetForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="budgetName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        <select class="form-select" id="budgetCategory" required>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="budgetAmount" required min="0" step="0.01">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Период</label>
                        <select class="form-select" id="budgetPeriod" required>
                            <option value="monthly">Месячный</option>
                            <option value="weekly">Недельный</option>
                            <option value="quarterly">Квартальный</option>
                            <option value="yearly">Годовой</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addBudget()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить тег</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTagForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="tagName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Цвет</label>
                        <input type="color" class="form-control form-control-color" id="tagColor" value="#5e72e4">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addTag()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить цель накопления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="goalName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Целевая сумма</label>
                        <input type="number" class="form-control" id="goalAmount" required min="0" step="0.01">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Целевая дата</label>
                        <input type="date" class="form-control" id="goalDate">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Счет для накопления</label>
                        <select class="form-select" id="goalAccount">
                            <option value="">Без привязки к счету</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Заметки</label>
                        <textarea class="form-control" id="goalNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addGoal()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Recurring Transaction Modal -->
<div class="modal fade" id="addRecurringModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить повторяющуюся транзакцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRecurringForm">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="recurringName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="recurring_type" id="recurringExpense"
                                   value="expense" checked>
                            <label class="btn btn-outline-danger" for="recurringExpense">Расход</label>

                            <input type="radio" class="btn-check" name="recurring_type" id="recurringIncome"
                                   value="income">
                            <label class="btn btn-outline-success" for="recurringIncome">Доход</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="recurringAmount" required min="0" step="0.01">
                    </div>

                    <div class="mb-3" id="recurringAccountFrom">
                        <label class="form-label">Счет</label>
                        <select class="form-select" id="recurringAccount" required>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        <select class="form-select" id="recurringCategory" required>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Частота</label>
                        <select class="form-select" id="recurringFrequency" required>
                            <option value="daily">Ежедневно</option>
                            <option value="weekly">Еженедельно</option>
                            <option value="monthly">Ежемесячно</option>
                            <option value="quarterly">Ежеквартально</option>
                            <option value="yearly">Ежегодно</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Дата начала</label>
                        <input type="date" class="form-control" id="recurringStartDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Дата окончания (опционально)</label>
                        <input type="date" class="form-control" id="recurringEndDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addRecurring()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // API Configuration
    const API_URL = 'http://localhost:8000/api';

    // Global variables
    let accounts = [];
    let categories = [];
    let tags = [];
    let expenseChart = null;
    let categoryChart = null;
    let trendChart = null;
    let selectedTags = [];
    let selectedDate = new Date();
    // Правильная инициализация currentSelectedDate без проблем с часовыми поясами
    let currentSelectedDate = (() => {
        const today = new Date();
        return new Date(today.getFullYear(), today.getMonth(), today.getDate());
    })();
    let accountBalanceChart = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...'); // Отладка

        initTheme();
        loadDashboard();
        loadAccounts();
        loadCategories();
        loadTags();

        // Set current date
        updateCurrentDateDisplay();

        // Set default date in form to selected date if forms exist
        const dateField = document.getElementById('date');
        const recurringStartDateField = document.getElementById('recurringStartDate');

        if (dateField) {
            dateField.value = formatDateForInput(currentSelectedDate);
        }
        if (recurringStartDateField) {
            recurringStartDateField.value = formatDateForInput(currentSelectedDate);
        }

        // The date picker now works directly via the input overlay
        console.log('Calendar should now work by clicking on the date area');

        // Transaction type change handler
        document.querySelectorAll('input[name="transaction_type"]').forEach(radio => {
            radio.addEventListener('change', updateTransactionForm);
        });

        document.querySelectorAll('input[name="recurring_type"]').forEach(radio => {
            radio.addEventListener('change', updateRecurringForm);
        });

        // Tab change handlers
        document.getElementById('transactions-tab').addEventListener('click', loadTransactions);
        document.getElementById('budgets-tab').addEventListener('click', loadBudgets);
        document.getElementById('goals-tab').addEventListener('click', loadGoals);
        document.getElementById('recurring-tab').addEventListener('click', loadRecurringTransactions);
        document.getElementById('analytics-tab').addEventListener('click', loadAnalytics);
        document.getElementById('settings-tab').addEventListener('click', () => {
            loadAccounts();
            loadCategories();
            loadTags();
        });

        // Search and filter handlers
        let searchTimeout;
        document.getElementById('transactionSearch').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchTransactions(), 300);
        });

        document.getElementById('transactionFilter').addEventListener('change', searchTransactions);
        document.getElementById('filterStartDate').addEventListener('change', searchTransactions);
        document.getElementById('filterEndDate').addEventListener('change', searchTransactions);

        console.log('Initialization complete'); // Отладка
    });

    // Make functions globally available for onclick handlers
    window.showDatePicker = showDatePicker;
    window.setTodayDate = setTodayDate;
    window.changeSelectedDate = changeSelectedDate;
    window.toggleTheme = toggleTheme;
    window.showAddTransactionModal = showAddTransactionModal;

    function openDatePicker() {
            const datePicker = document.getElementById('hiddenDatePicker');
            datePicker.value = currentSelectedDate.toISOString().split('T')[0];
            datePicker.focus();
            datePicker.click();

            // Для некоторых браузеров может потребоваться:
            if (datePicker.showPicker) {
                datePicker.showPicker();
            }
        }


    // Date management functions
    function updateCurrentDateDisplay() {
        const dateText = currentSelectedDate.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });

        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            currentDateElement.textContent = dateText;
        }

        // Check if selected date is today
        const today = new Date();
        const isToday = currentSelectedDate.toDateString() === today.toDateString();

        const navbarDate = document.getElementById('navbarDate');
        if (navbarDate) {
            if (isToday) {
                navbarDate.classList.remove('not-today');
                navbarDate.title = 'Изменить дату (сегодня)';
            } else {
                navbarDate.classList.add('not-today');
                navbarDate.title = 'Изменить дату (не сегодня - нажмите кнопку "дом" чтобы вернуться к сегодняшней дате)';
            }
        }

        // Update the hidden date picker value using our safe formatting function
        const hiddenDatePicker = document.getElementById('hiddenDatePicker');
        if (hiddenDatePicker) {
            hiddenDatePicker.value = formatDateForInput(currentSelectedDate);
        }
    }

    function showDatePicker() {
        console.log('showDatePicker called'); // Отладка
        try {
            const hiddenDatePicker = document.getElementById('hiddenDatePicker');
            if (hiddenDatePicker) {
                hiddenDatePicker.value = currentSelectedDate.toISOString().split('T')[0];
                hiddenDatePicker.focus(); // Попробуем фокус вместо клика
                hiddenDatePicker.click();
                console.log('Date picker focused and clicked'); // Отладка
            } else {
                console.error('Hidden date picker not found');
            }
        } catch (error) {
            console.error('Error in showDatePicker:', error);
        }
    }

    function changeSelectedDate(dateValue) {
        console.log('changeSelectedDate called with:', dateValue); // Отладка
        try {
            // Исправляем проблему с часовыми поясами
            const dateParts = dateValue.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // месяцы в JS начинаются с 0
            const day = parseInt(dateParts[2]);

            currentSelectedDate = new Date(year, month, day);
            console.log('Created date object:', currentSelectedDate); // Отладка

            updateCurrentDateDisplay();

            // Update default date in forms if they exist
            const dateField = document.getElementById('date');
            const recurringStartDateField = document.getElementById('recurringStartDate');

            if (dateField) {
                dateField.value = dateValue;
            }
            if (recurringStartDateField) {
                recurringStartDateField.value = dateValue;
            }
            console.log('Selected date updated to:', dateValue); // Отладка
        } catch (error) {
            console.error('Error in changeSelectedDate:', error);
        }
    }

    function setTodayDate() {
        console.log('setTodayDate called'); // Отладка
        try {
            const today = new Date();
            currentSelectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            updateCurrentDateDisplay();

            const todayString = formatDateForInput(currentSelectedDate);

            // Update hidden date picker
            const hiddenDatePicker = document.getElementById('hiddenDatePicker');
            if (hiddenDatePicker) {
                hiddenDatePicker.value = todayString;
            }

            // Update forms if they exist
            const dateField = document.getElementById('date');
            const recurringStartDateField = document.getElementById('recurringStartDate');

            if (dateField) {
                dateField.value = todayString;
            }
            if (recurringStartDateField) {
                recurringStartDateField.value = todayString;
            }
            console.log('Date set to today:', todayString); // Отладка
        } catch (error) {
            console.error('Error in setTodayDate:', error);
        }
    }

    // Новая функция для правильного форматирования даты
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Theme management
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);

        // Update charts colors
        updateChartsTheme();
    }

    function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        icon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
    }

    function updateChartsTheme() {
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');

        // Update all charts
        [expenseChart, categoryChart, trendChart, accountBalanceChart].forEach(chart => {
            if (chart) {
                chart.options.plugins.legend.labels.color = textColor;
                chart.options.scales?.x && (chart.options.scales.x.ticks.color = textColor);
                chart.options.scales?.y && (chart.options.scales.y.ticks.color = textColor);
                chart.options.scales?.x && (chart.options.scales.x.grid.color = gridColor);
                chart.options.scales?.y && (chart.options.scales.y.grid.color = gridColor);
                chart.update();
            }
        });
    }

    // Search transactions
    async function searchTransactions() {
        const searchQuery = document.getElementById('transactionSearch').value;
        const typeFilter = document.getElementById('transactionFilter').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;

        showLoading(true);
        try {
            let url = '/data/search/transactions?limit=100';

            if (searchQuery) url += `&q=${encodeURIComponent(searchQuery)}`;
            if (typeFilter) url += `&transaction_types=${typeFilter}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (selectedTags.length > 0) {
                url += `&tag_ids=${selectedTags.join(',')}`;
            }

            const result = await fetchAPI(url);
            displayTransactions(result.transactions);

            // Show result count
            const countInfo = `<small class="text-muted">Найдено: ${result.total} транзакций</small>`;
            document.getElementById('allTransactions').insertAdjacentHTML('afterbegin', countInfo);
        } catch (error) {
            showError('Ошибка поиска');
        } finally {
            showLoading(false);
        }
    }

    // Loading functions
    async function loadDashboard() {
        showLoading(true);
        try {
            // Load stats
            const stats = await fetchAPI('/analytics/dashboard');
            displayStats(stats);

            // Load recent transactions
            const transactions = await fetchAPI('/transactions?limit=5');
            displayRecentTransactions(transactions);

            // Load charts
            await loadDashboardCharts();
        } catch (error) {
            showError('Ошибка загрузки данных');
        } finally {
            showLoading(false);
        }
    }

    async function loadDashboardCharts() {
        // Get dashboard data
        const stats = await fetchAPI('/analytics/dashboard');

        // Load expense chart data
        if (stats.daily_expenses && stats.daily_expenses.length > 0) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');

            if (expenseChart) expenseChart.destroy();

            // Fill in missing dates
            const expensesByDate = {};
            stats.daily_expenses.forEach(d => {
                expensesByDate[d.date] = d.amount;
            });

            // Create array of last 30 days
            const daily = stats.daily_expenses.map(d => {
              const [y, m, day] = d.date.split("-").map(Number);
              return { date: new Date(y, m - 1, day), amount: d.amount };
            });

            const labels = daily.map(d =>
              d.date.toLocaleDateString("ru-RU", { day: "numeric", month: "short" })
            );
            const dataPoints = daily.map(d => d.amount);

            expenseChart = new Chart(ctx, {
              type: "line",
              data: {
                labels,
                datasets: [{
                  label: "Расходы",
                  data: dataPoints,
                  borderColor: "#f5365c",
                  backgroundColor: "rgba(245, 54, 92, 0.1)",
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return "Расходы: " + formatMoney(context.parsed.y);
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: value => formatMoney(value),
                      color: textColor
                    },
                    grid: { color: gridColor }
                  },
                  x: {
                    ticks: {
                      color: textColor,
                      maxRotation: 45,
                      minRotation: 0
                    },
                    grid: {
                      color: gridColor,
                      display: false
                    }
                  }
                }
              }
            });
        }

        // Load category chart from dashboard data
        if (stats.category_breakdown && stats.category_breakdown.length > 0) {
            const ctx2 = document.getElementById('categoryChart').getContext('2d');

            if (categoryChart) categoryChart.destroy();

            const categoryData = stats.category_breakdown.slice(0, 5);
            categoryChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(c => c.category_name),
                    datasets: [{
                        data: categoryData.map(c => c.amount),
                        backgroundColor: categoryData.map(c => c.color || '#5e72e4'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = Math.round((value / total) * 100);
                                    return context.label + ': ' + formatMoney(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    async function loadAccounts() {
        accounts = await fetchAPI('/accounts');
        displayAccounts();
        updateAccountSelects();
    }

    async function loadCategories() {
        categories = await fetchAPI('/categories');
        displayCategories();
        updateCategorySelect();
    }

    async function loadTags() {
        tags = await fetchAPI('/tags');
        displayTags();
        updateTagsSelect();
    }

    async function loadTransactions() {
        showLoading(true);
        try {
            const filter = document.getElementById('transactionFilter').value;
            const url = filter ? `/transactions?transaction_type=${filter}` : '/transactions';
            const transactions = await fetchAPI(url);
            displayTransactions(transactions);
        } catch (error) {
            showError('Ошибка загрузки транзакций');
        } finally {
            showLoading(false);
        }
    }

    async function loadBudgets() {
        showLoading(true);
        try {
            const budgets = await fetchAPI('/budgets');
            displayBudgets(budgets);
        } catch (error) {
            showError('Ошибка загрузки бюджетов');
        } finally {
            showLoading(false);
        }
    }

    async function loadGoals() {
        showLoading(true);
        try {
            const goals = await fetchAPI('/savings-goals');
            displayGoals(goals);
        } catch (error) {
            showError('Ошибка загрузки целей');
        } finally {
            showLoading(false);
        }
    }

    async function loadRecurringTransactions() {
        showLoading(true);
        try {
            const recurring = await fetchAPI('/recurring-transactions');
            displayRecurringTransactions(recurring);
        } catch (error) {
            showError('Ошибка загрузки повторяющихся транзакций');
        } finally {
            showLoading(false);
        }
    }

    async function loadAnalytics() {
        showLoading(true);
        try {
            // Load trends
            await loadTrends();

            // Load category analytics
            const categoryAnalytics = await fetchAPI('/analytics/categories?transaction_type=expense');
            displayCategoryAnalytics(categoryAnalytics);

            // Load forecast - try detailed first, then simple
            try {
                const forecast = await fetchAPI('/analytics/forecast/detailed?months_ahead=3');
                displayForecast(forecast);
            } catch (error) {
                // If detailed forecast fails, try simple forecast
                const simpleForecast = await fetchAPI('/analytics/forecast?months_ahead=3');
                displayForecast(simpleForecast);
            }

            // Load monthly comparison
            const monthlyComparison = await fetchAPI('/analytics/monthly-comparison?months_back=3');
            displayMonthlyComparison(monthlyComparison);

            // Load account balances
            const accountBalances = await fetchAPI('/analytics/account-balances');
            displayAccountBalances(accountBalances);

            // Load top expenses
            const topExpenses = await fetchAPI('/analytics/top-expenses?limit=10&days=30');
            displayTopExpenses(topExpenses);

        } catch (error) {
            showError('Ошибка загрузки аналитики');
        } finally {
            showLoading(false);
        }
    }

    async function loadTrends() {
        const period = document.getElementById('trendPeriod')?.value || 'monthly';
        const months = period === 'daily' ? 1 : 6;

        try {
            const trends = await fetchAPI(`/analytics/trends?period=${period}&months=${months}`);
            displayTrends(trends);
        } catch (error) {
            console.error('Error loading trends:', error);
        }
    }

    // Display functions
    function displayStats(stats) {
        const statsRow = document.getElementById('statsRow');
        statsRow.innerHTML = `
            <div class="col-lg-3 col-sm-6">
                <div class="card stat-card">
                    <div class="d-flex align-items-center">
                        <div class="icon bg-primary bg-gradient">
                            <i class="bi bi-wallet2"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Общий баланс</h6>
                            <h4 class="mb-0">${formatMoney(stats.total_balance || 0)}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card stat-card">
                    <div class="d-flex align-items-center">
                        <div class="icon bg-success bg-gradient">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Доходы за месяц</h6>
                            <h4 class="mb-0">${formatMoney(stats.total_income || 0)}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card stat-card">
                    <div class="d-flex align-items-center">
                        <div class="icon bg-danger bg-gradient">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Расходы за месяц</h6>
                            <h4 class="mb-0">${formatMoney(stats.total_expense || 0)}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card stat-card">
                    <div class="d-flex align-items-center">
                        <div class="icon bg-info bg-gradient">
                            <i class="bi bi-piggy-bank"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="text-muted mb-1">Сбережения за месяц</h6>
                            <h4 class="mb-0">${formatMoney(stats.net_savings || stats.net_balance || 0)}</h4>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function displayRecentTransactions(transactions) {
        const container = document.getElementById('recentTransactions');
        if (transactions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">Нет транзакций</p>';
            return;
        }

        container.innerHTML = transactions.map(t => `
            <div class="transaction-item d-flex align-items-center">
                <div class="category-icon" style="background-color: ${t.category_color}20; color: ${t.category_color}">
                    ${t.category_icon || '📝'}
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold">${t.description || t.category_name}</div>
                    <small class="text-muted">${formatDate(t.date)} • ${getAccountName(t)}</small>
                </div>
                <div class="amount-${t.type}">
                    ${t.type === 'expense' ? '-' : '+'} ${formatMoney(t.amount)}
                </div>
            </div>
        `).join('');
    }

    function displayTransactions(transactions) {
        const container = document.getElementById('allTransactions');
        if (transactions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">Нет транзакций</p>';
            return;
        }

        container.innerHTML = transactions.map(t => `
            <div class="transaction-item d-flex align-items-center">
                <div class="category-icon" style="background-color: ${t.category_color}20; color: ${t.category_color}">
                    ${t.category_icon || '📝'}
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold">${t.description || t.category_name}</div>
                    <small class="text-muted">${formatDate(t.date)} • ${getAccountName(t)}</small>
                    ${t.tags && t.tags.length > 0 ? `<div class="mt-1">${t.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}</div>` : ''}
                </div>
                <div class="d-flex align-items-center">
                    <div class="amount-${t.type} me-3">
                        ${t.type === 'expense' ? '-' : '+'} ${formatMoney(t.amount)}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${t.id})" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function displayBudgets(budgets) {
        const container = document.getElementById('budgetsList');
        if (budgets.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Нет бюджетов</p></div>';
            return;
        }

        container.innerHTML = budgets.map(b => {
            // Calculate usage percentage if not provided
            const usagePercentage = b.usage_percentage || (b.spent_amount && b.amount ? Math.round((b.spent_amount / b.amount) * 100) : 0);
            const progressColor = usagePercentage > 80 ? 'danger' : (usagePercentage > 60 ? 'warning' : 'success');

            return `
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${b.name}</h6>
                                    <small class="text-muted">${b.category_name || 'Категория'}</small>
                                </div>
                                <div>
                                    <span class="badge bg-${progressColor}">${usagePercentage}%</span>
                                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteBudget(${b.id})" title="Удалить">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small>Потрачено: ${formatMoney(b.spent_amount || 0)}</small>
                                <small>Лимит: ${formatMoney(b.amount)}</small>
                            </div>
                            <div class="budget-progress">
                                <div class="budget-progress-bar bg-${progressColor}" style="width: ${Math.min(usagePercentage, 100)}%"></div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">${b.period === 'monthly' ? 'Месячный' :
                                    b.period === 'weekly' ? 'Недельный' :
                                    b.period === 'quarterly' ? 'Квартальный' :
                                    b.period === 'yearly' ? 'Годовой' : b.period}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayGoals(goals) {
        const container = document.getElementById('goalsList');
        if (goals.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Нет целей накопления</p></div>';
            return;
        }

        container.innerHTML = goals.map(g => {
            const progressPercentage = g.progress_percentage || (g.target_amount > 0 ? Math.round((g.current_amount / g.target_amount) * 100) : 0);

            return `
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">${g.name}</h6>
                                    ${g.target_date ? `<small class="text-muted">До ${formatDate(g.target_date)}</small>` : ''}
                                </div>
                                <span class="badge bg-primary">${progressPercentage}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <small>Накоплено: ${formatMoney(g.current_amount)}</small>
                                <small>Цель: ${formatMoney(g.target_amount)}</small>
                            </div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar" style="width: ${Math.min(progressPercentage, 100)}%"></div>
                            </div>
                            ${g.account_name ? `<small class="text-muted mt-2 d-block">${g.account_icon || '💳'} ${g.account_name}</small>` : ''}
                            <div class="mt-3">
                                ${!g.is_achieved ? `
                                    <button class="btn btn-sm btn-success" onclick="showContributeModal(${g.id})">
                                        <i class="bi bi-plus-circle"></i> Пополнить
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteGoal(${g.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : '<span class="badge bg-success">Достигнута!</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayRecurringTransactions(recurring) {
        const container = document.getElementById('recurringList');
        if (recurring.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Нет повторяющихся транзакций</p></div>';
            return;
        }

        container.innerHTML = recurring.map(r => `
            <div class="col-lg-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${r.name}</h6>
                                <span class="badge bg-${r.type === 'expense' ? 'danger' : 'success'}">${r.type === 'expense' ? 'Расход' : 'Доход'}</span>
                                <span class="badge bg-secondary ms-1">${getFrequencyName(r.frequency)}</span>
                            </div>
                            <div class="text-end">
                                <div class="amount-${r.type}">${formatMoney(r.amount)}</div>
                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteRecurring(${r.id})" title="Удалить">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted d-block">${r.category_name}</small>
                            <small class="text-muted">С ${formatDate(r.start_date)} ${r.end_date ? `до ${formatDate(r.end_date)}` : ''}</small>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-primary" onclick="processRecurring(${r.id})">
                                <i class="bi bi-play-fill"></i> Создать транзакции
                            </button>
                            ${r.is_active ? `<button class="btn btn-sm btn-outline-secondary" onclick="toggleRecurring(${r.id}, false)">
                                <i class="bi bi-pause-fill"></i> Приостановить
                            </button>` : `<button class="btn btn-sm btn-outline-success" onclick="toggleRecurring(${r.id}, true)">
                                <i class="bi bi-play-fill"></i> Активировать
                            </button>`}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function displayAccounts() {
        const container = document.getElementById('accountsList');
        container.innerHTML = accounts.map(a => `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="fw-semibold">${a.icon || '💳'} ${a.name}</div>
                    <small class="text-muted">${getAccountTypeName(a.type)} • ${a.currency || 'KZT'}</small>
                </div>
                <div class="text-end">
                    <div class="fw-semibold">${formatMoney(a.current_balance)}</div>
                    <small class="text-muted">${a.transaction_count || 0} транзакций</small>
                </div>
            </div>
        `).join('');
    }

    function displayCategories() {
        const container = document.getElementById('categoriesList');
        const groupedCategories = {};

        // Group by type
        categories.forEach(c => {
            if (!groupedCategories[c.type]) {
                groupedCategories[c.type] = [];
            }
            groupedCategories[c.type].push(c);
        });

        let html = '';
        for (const [type, cats] of Object.entries(groupedCategories)) {
            html += `<h6 class="text-muted mb-2">${type === 'expense' ? 'Расходы' : 'Доходы'}</h6>`;
            html += cats.filter(c => c.level === 0).map(c => `
                <div class="mb-2">
                    <span class="badge" style="background-color: ${c.color}20; color: ${c.color}">
                        ${c.icon || '📁'} ${c.name}
                    </span>
                </div>
            `).join('');
        }

        container.innerHTML = html;
    }

    function displayTags() {
        const container = document.getElementById('tagsList');
        container.innerHTML = tags.map(t => `
            <span class="tag-badge" style="background-color: ${t.color}20; color: ${t.color}"
                  onclick="deleteTag(${t.id})" title="Нажмите для удаления">
                ${t.name} <small>(${t.usage_count || 0})</small>
            </span>
        `).join('');
    }

    function displayTrends(trends) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();

        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');

        // Format labels based on period type
        const period = document.getElementById('trendPeriod')?.value || 'monthly';
        let labels = trends.map(t => {
            if (period === 'daily') {
                return new Date(t.period).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            } else if (period === 'weekly') {
                return `Неделя ${t.period.split('-')[1]}`;
            } else {
                return formatMonth(t.period);
            }
        });

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Доходы',
                        data: trends.map(t => t.income),
                        borderColor: '#2dce89',
                        backgroundColor: 'rgba(45, 206, 137, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Расходы',
                        data: trends.map(t => t.expenses),
                        borderColor: '#f5365c',
                        backgroundColor: 'rgba(245, 54, 92, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value);
                            },
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                        ticks: {
                            color: textColor,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                }
            }
        });
    }

    function displayCategoryAnalytics(data) {
        const container = document.getElementById('categoryAnalytics');
        container.innerHTML = data.map(c => `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <div class="category-icon me-2" style="background-color: ${c.color}20; color: ${c.color}; width: 32px; height: 32px; font-size: 1rem;">
                        ${c.icon || '📁'}
                    </div>
                    <div>
                        <div class="fw-semibold">${c.name}</div>
                        <small class="text-muted">${c.transaction_count} транзакций</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-semibold">${formatMoney(c.total_amount)}</div>
                    <small class="text-muted">${c.percentage}%</small>
                </div>
            </div>
        `).join('');
    }

    function displayForecast(forecast) {
        const container = document.getElementById('forecastContent');

        // If forecast is empty or no detailed data
        if (!forecast || (Array.isArray(forecast) && forecast.length === 0)) {
            container.innerHTML = '<p class="text-muted">Нет данных для прогноза</p>';
            return;
        }

        // If forecast is an array (simple forecast)
        if (Array.isArray(forecast)) {
            const totalExpenses = forecast.reduce((sum, f) => sum + f.expense, 0);
            const totalIncome = forecast.reduce((sum, f) => sum + f.income, 0);

            container.innerHTML = `
                <div class="mb-4">
                    <h6>Прогноз на ${forecast.length} ${getMonthsWord(forecast.length)}</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Доходы:</small>
                            <h5 class="text-success">${formatMoney(totalIncome)}</h5>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Расходы:</small>
                            <h5 class="text-danger">${formatMoney(totalExpenses)}</h5>
                        </div>
                    </div>
                </div>
                <div>
                    <h6 class="mb-3">По месяцам:</h6>
                    ${forecast.map(f => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>${f.month}</span>
                            <div>
                                <small class="text-success me-2">+${formatMoney(f.income)}</small>
                                <small class="text-danger">-${formatMoney(f.expense)}</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        // If forecast has detailed structure
        else if (forecast.total_forecast !== undefined) {
            container.innerHTML = `
                <div class="mb-4">
                    <h6>Прогноз на ${forecast.months_ahead} ${getMonthsWord(forecast.months_ahead)}</h6>
                    <h3 class="text-danger">${formatMoney(forecast.total_forecast)}</h3>
                </div>
                <div>
                    <h6 class="mb-3">По категориям:</h6>
                    ${forecast.by_category.map(c => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <span style="color: ${c.color}">${c.icon || '📁'}</span>
                                <span class="ms-2">${c.name}</span>
                            </div>
                            <small>${formatMoney(c.forecast_total)}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    }

    function displayMonthlyComparison(data) {
        const container = document.getElementById('monthlyComparisonContent');
        if (!data || data.length === 0) {
            container.innerHTML = '<p class="text-muted">Нет данных для сравнения</p>';
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Месяц</th>
                            <th class="text-end">Доходы</th>
                            <th class="text-end">Расходы</th>
                            <th class="text-end">Баланс</th>
                            <th class="text-end">Сберегли</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(month => `
                            <tr>
                                <td>${formatMonth(month.month)}</td>
                                <td class="text-end text-success">${formatMoney(month.income)}</td>
                                <td class="text-end text-danger">${formatMoney(month.expenses)}</td>
                                <td class="text-end ${month.net >= 0 ? 'text-success' : 'text-danger'}">${formatMoney(month.net)}</td>
                                <td class="text-end">${month.savings_rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function displayAccountBalances(data) {
        const ctx = document.getElementById('accountBalanceChart').getContext('2d');

        if (accountBalanceChart) accountBalanceChart.destroy();

        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');

        accountBalanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.accounts.map(a => a.name),
                datasets: [{
                    data: data.accounts.map(a => a.balance),
                    backgroundColor: data.accounts.map(a => a.color || '#5e72e4'),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const account = chart.options.accountData[i];
                                        return {
                                            text: `${account.icon || '💳'} ${label}: ${formatMoney(value)}`,
                                            fillStyle: dataset.backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const account = data.accounts[context.dataIndex];
                                return `${account.name}: ${formatMoney(context.parsed)} (${account.percentage}%)`;
                            }
                        }
                    }
                },
                accountData: data.accounts
            }
        });
    }

    function displayTopExpenses(expenses) {
        const container = document.getElementById('topExpensesContent');
        if (!expenses || expenses.length === 0) {
            container.innerHTML = '<p class="text-muted">Нет расходов за период</p>';
            return;
        }

        container.innerHTML = expenses.map((expense, index) => `
            <div class="d-flex justify-content-between align-items-center mb-3 ${index < expenses.length - 1 ? 'pb-3 border-bottom' : ''}">
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger me-2">${index + 1}</span>
                    <div>
                        <div class="fw-semibold">${expense.description || expense.category.name}</div>
                        <small class="text-muted">
                            <span style="color: ${expense.category.color}">${expense.category.icon || '📁'}</span>
                            ${expense.category.name} • ${formatDate(expense.date)}
                        </small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-semibold text-danger">${formatMoney(expense.amount)}</div>
                    <small class="text-muted">${expense.account}</small>
                </div>
            </div>
        `).join('');
    }

    function formatMonth(monthString) {
        const [year, month] = monthString.split('-');
        const date = new Date(year, parseInt(month) - 1);
        return date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
    }

    // Form handlers
    function updateTransactionForm() {
        const type = document.querySelector('input[name="transaction_type"]:checked').value;
        const accountFromGroup = document.getElementById('accountFromGroup');
        const accountToGroup = document.getElementById('accountToGroup');
        const categoryGroup = document.getElementById('categoryGroup');

        switch(type) {
            case 'expense':
                accountFromGroup.classList.remove('d-none');
                accountToGroup.classList.add('d-none');
                categoryGroup.classList.remove('d-none');
                document.getElementById('accountFrom').required = true;
                document.getElementById('accountTo').required = false;
                updateCategorySelect('expense');
                break;
            case 'income':
                accountFromGroup.classList.add('d-none');
                accountToGroup.classList.remove('d-none');
                categoryGroup.classList.remove('d-none');
                document.getElementById('accountFrom').required = false;
                document.getElementById('accountTo').required = true;
                updateCategorySelect('income');
                break;
            case 'transfer':
                accountFromGroup.classList.remove('d-none');
                accountToGroup.classList.remove('d-none');
                categoryGroup.classList.add('d-none');
                document.getElementById('accountFrom').required = true;
                document.getElementById('accountTo').required = true;
                break;
        }
    }

    function updateRecurringForm() {
        const type = document.querySelector('input[name="recurring_type"]:checked').value;
        const label = document.querySelector('#recurringAccountFrom label');
        label.textContent = type === 'expense' ? 'Со счета' : 'На счет';
        updateCategorySelect(type, 'recurringCategory');
    }

    function updateAccountSelects() {
        const accountFromSelect = document.getElementById('accountFrom');
        const accountToSelect = document.getElementById('accountTo');
        const recurringAccountSelect = document.getElementById('recurringAccount');
        const goalAccountSelect = document.getElementById('goalAccount');

        const options = accounts.filter(a => a.is_active).map(a =>
            `<option value="${a.id}">${a.icon || '💳'} ${a.name} (${formatMoney(a.current_balance)})</option>`
        ).join('');

        if (accountFromSelect) accountFromSelect.innerHTML = '<option value="">Выберите счет</option>' + options;
        if (accountToSelect) accountToSelect.innerHTML = '<option value="">Выберите счет</option>' + options;
        if (recurringAccountSelect) recurringAccountSelect.innerHTML = '<option value="">Выберите счет</option>' + options;
        if (goalAccountSelect) goalAccountSelect.innerHTML = '<option value="">Без привязки к счету</option>' + options;
    }

    function updateCategorySelect(type = 'expense', selectId = 'category') {
        const categorySelect = document.getElementById(selectId);
        if (!categorySelect) return;

        const filteredCategories = categories.filter(c => c.type === type && c.is_active);

        const mainCategories = filteredCategories.filter(c => !c.parent_id);
        const subcategories = filteredCategories.filter(c => c.parent_id);

        let optionsHtml = '<option value="">Выберите категорию</option>';

        mainCategories.forEach(main => {
            optionsHtml += `<option value="${main.id}" style="font-weight: bold;">${main.icon || '📁'} ${main.name}</option>`;

            const subs = subcategories.filter(s => s.parent_id === main.id);
            subs.forEach(sub => {
                optionsHtml += `<option value="${sub.id}" style="padding-left: 20px;">&nbsp;&nbsp;${sub.icon || '📄'} ${sub.name}</option>`;
            });
        });

        categorySelect.innerHTML = optionsHtml;
    }

    function updateTagsSelect() {
        const container = document.getElementById('transactionTags');
        const selectedContainer = document.getElementById('selectedTags');

        if (container) {
            container.innerHTML = tags.map(t => `
                <span class="tag-badge" id="tag-${t.id}"
                      style="background-color: ${t.color}20; color: ${t.color}"
                      onclick="toggleTag(${t.id})">
                    ${t.name}
                </span>
            `).join('');
        }

        // Update filter tags
        if (selectedContainer) {
            selectedContainer.innerHTML = tags.map(t => `
                <span class="tag-badge" id="filter-tag-${t.id}"
                      style="background-color: ${t.color}20; color: ${t.color}"
                      onclick="toggleFilterTag(${t.id})">
                    ${t.name}
                </span>
            `).join('');
        }
    }

    function toggleTag(tagId) {
        const tag = document.getElementById(`tag-${tagId}`);
        const index = selectedTags.indexOf(tagId);

        if (index > -1) {
            selectedTags.splice(index, 1);
            tag.classList.remove('selected');
        } else {
            selectedTags.push(tagId);
            tag.classList.add('selected');
        }
    }

    function toggleFilterTag(tagId) {
        const tag = document.getElementById(`filter-tag-${tagId}`);
        const index = selectedTags.indexOf(tagId);

        if (index > -1) {
            selectedTags.splice(index, 1);
            tag.classList.remove('selected');
        } else {
            selectedTags.push(tagId);
            tag.classList.add('selected');
        }

        searchTransactions();
    }

    // CRUD operations
    async function addTransaction() {
        const type = document.querySelector('input[name="transaction_type"]:checked').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const description = document.getElementById('description').value;

        if (!amount || amount <= 0) {
            showError('Введите корректную сумму');
            return;
        }

        if (!date) {
            showError('Выберите дату');
            return;
        }

        const transaction = {
            transaction_type: type,
            amount,
            date,
            description,
            account_from_id: null,
            account_to_id: null,
            category_id: null,
            tag_ids: selectedTags
        };

        switch(type) {
            case 'expense':
                const accountFrom = document.getElementById('accountFrom').value;
                const categoryExp = document.getElementById('category').value;

                if (!accountFrom) {
                    showError('Выберите счет списания');
                    return;
                }
                if (!categoryExp) {
                    showError('Выберите категорию расхода');
                    return;
                }

                transaction.account_from_id = parseInt(accountFrom);
                transaction.category_id = parseInt(categoryExp);
                break;

            case 'income':
                const accountTo = document.getElementById('accountTo').value;
                const categoryInc = document.getElementById('category').value;

                if (!accountTo) {
                    showError('Выберите счет пополнения');
                    return;
                }
                if (!categoryInc) {
                    showError('Выберите категорию дохода');
                    return;
                }

                transaction.account_to_id = parseInt(accountTo);
                transaction.category_id = parseInt(categoryInc);
                break;

            case 'transfer':
                const accFrom = document.getElementById('accountFrom').value;
                const accTo = document.getElementById('accountTo').value;

                if (!accFrom) {
                    showError('Выберите счет списания');
                    return;
                }
                if (!accTo) {
                    showError('Выберите счет пополнения');
                    return;
                }
                if (accFrom === accTo) {
                    showError('Выберите разные счета для перевода');
                    return;
                }

                transaction.account_from_id = parseInt(accFrom);
                transaction.account_to_id = parseInt(accTo);
                break;
        }

        try {
            await postAPI('/transactions', transaction);
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            document.getElementById('addTransactionForm').reset();
            // Reset date to selected calendar date using safe formatting
            document.getElementById('date').value = formatDateForInput(currentSelectedDate);
            selectedTags = [];
            updateTagsSelect();
            loadDashboard();
            loadTransactions();
            showSuccess('Транзакция добавлена');
        } catch (error) {
            showError('Ошибка при добавлении транзакции');
        }
    }

    async function deleteTransaction(id) {
        if (!confirm('Вы уверены, что хотите удалить эту транзакцию?')) return;

        try {
            await deleteAPI(`/transactions/${id}`);
            loadTransactions();
            loadDashboard();
            showSuccess('Транзакция удалена');
        } catch (error) {
            showError('Ошибка при удалении транзакции');
        }
    }

    async function addAccount() {
        const account = {
            name: document.getElementById('accountName').value,
            account_type: document.getElementById('accountType').value,
            initial_balance: parseFloat(document.getElementById('initialBalance').value) || 0,
            currency: document.getElementById('accountCurrency').value,
            icon: document.getElementById('accountIcon').value || '💳',
            color: document.getElementById('accountColor').value
        };

        try {
            await postAPI('/accounts', account);
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            document.getElementById('addAccountForm').reset();
            loadAccounts();
            showSuccess('Счет добавлен');
        } catch (error) {
            showError('Ошибка при добавлении счета');
        }
    }

    async function addCategory() {
        const category = {
            name: document.getElementById('categoryName').value,
            category_type: document.getElementById('categoryType').value,
            parent_id: parseInt(document.getElementById('parentCategory').value) || null,
            icon: document.getElementById('categoryIcon').value || '📁',
            color: document.getElementById('categoryColor').value
        };

        try {
            await postAPI('/categories', category);
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            document.getElementById('addCategoryForm').reset();
            loadCategories();
            showSuccess('Категория добавлена');
        } catch (error) {
            showError('Ошибка при добавлении категории');
        }
    }

    async function addBudget() {
        const budget = {
            name: document.getElementById('budgetName').value,
            category_id: parseInt(document.getElementById('budgetCategory').value),
            amount: parseFloat(document.getElementById('budgetAmount').value),
            period: document.getElementById('budgetPeriod').value,
            start_date: new Date().toISOString().split('T')[0]
        };

        try {
            await postAPI('/budgets', budget);
            bootstrap.Modal.getInstance(document.getElementById('addBudgetModal')).hide();
            document.getElementById('addBudgetForm').reset();
            loadBudgets();
            showSuccess('Бюджет добавлен');
        } catch (error) {
            showError('Ошибка при добавлении бюджета');
        }
    }

    async function addTag() {
        const tag = {
            name: document.getElementById('tagName').value,
            color: document.getElementById('tagColor').value
        };

        try {
            await postAPI('/tags', tag);
            bootstrap.Modal.getInstance(document.getElementById('addTagModal')).hide();
            document.getElementById('addTagForm').reset();
            loadTags();
            showSuccess('Тег добавлен');
        } catch (error) {
            showError('Ошибка при добавлении тега');
        }
    }

    async function deleteTag(id) {
        if (!confirm('Вы уверены, что хотите удалить этот тег?')) return;

        try {
            await deleteAPI(`/tags/${id}`);
            loadTags();
            showSuccess('Тег удален');
        } catch (error) {
            showError('Ошибка при удалении тега');
        }
    }

    async function addGoal() {
        const goal = {
            name: document.getElementById('goalName').value,
            target_amount: parseFloat(document.getElementById('goalAmount').value),
            target_date: document.getElementById('goalDate').value || null,
            account_id: parseInt(document.getElementById('goalAccount').value) || null,
            notes: document.getElementById('goalNotes').value
        };

        try {
            await postAPI('/savings-goals', goal);
            bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
            document.getElementById('addGoalForm').reset();
            loadGoals();
            showSuccess('Цель добавлена');
        } catch (error) {
            showError('Ошибка при добавлении цели');
        }
    }

    async function deleteGoal(id) {
        if (!confirm('Вы уверены, что хотите удалить эту цель?')) return;

        try {
            await deleteAPI(`/savings-goals/${id}`);
            loadGoals();
            showSuccess('Цель удалена');
        } catch (error) {
            showError('Ошибка при удалении цели');
        }
    }

    async function showContributeModal(goalId) {
        const amount = prompt('Введите сумму пополнения:');
        if (!amount) return;

        const parsedAmount = parseFloat(amount);
        if (isNaN(parsedAmount) || parsedAmount <= 0) {
            showError('Введите корректную сумму');
            return;
        }

        try {
            await postAPI(`/savings-goals/${goalId}/deposit?amount=${parsedAmount}`);
            loadGoals();
            showSuccess('Цель пополнена');
        } catch (error) {
            showError('Ошибка при пополнении цели');
        }
    }

    async function addRecurring() {
        const type = document.querySelector('input[name="recurring_type"]:checked').value;
        const recurring = {
            name: document.getElementById('recurringName').value,
            transaction_type: type,
            amount: parseFloat(document.getElementById('recurringAmount').value),
            category_id: parseInt(document.getElementById('recurringCategory').value),
            frequency: document.getElementById('recurringFrequency').value,
            start_date: document.getElementById('recurringStartDate').value,
            end_date: document.getElementById('recurringEndDate').value || null
        };

        const accountId = parseInt(document.getElementById('recurringAccount').value);
        if (type === 'expense') {
            recurring.account_from_id = accountId;
        } else {
            recurring.account_to_id = accountId;
        }

        try {
            await postAPI('/recurring-transactions', recurring);
            bootstrap.Modal.getInstance(document.getElementById('addRecurringModal')).hide();
            document.getElementById('addRecurringForm').reset();
            loadRecurringTransactions();
            showSuccess('Повторяющаяся транзакция добавлена');
        } catch (error) {
            showError('Ошибка при добавлении повторяющейся транзакции');
        }
    }

    async function processRecurring(id) {
        try {
            const result = await postAPI(`/recurring-transactions/${id}/process`);
            loadRecurringTransactions();
            showSuccess(`Создано транзакций: ${result.created}`);
        } catch (error) {
            showError('Ошибка при обработке повторяющейся транзакции');
        }
    }

    async function deleteRecurring(id) {
        if (!confirm('Вы уверены, что хотите удалить эту повторяющуюся транзакцию?')) return;

        try {
            await deleteAPI(`/recurring-transactions/${id}`);
            loadRecurringTransactions();
            showSuccess('Повторяющаяся транзакция удалена');
        } catch (error) {
            showError('Ошибка при удалении повторяющейся транзакции');
        }
    }

    async function deleteBudget(id) {
        if (!confirm('Вы уверены, что хотите удалить этот бюджет?')) return;

        try {
            await deleteAPI(`/budgets/${id}`);
            loadBudgets();
            showSuccess('Бюджет удален');
        } catch (error) {
            showError('Ошибка при удалении бюджета');
        }
    }

    // Export/Import functions
    async function exportData(format) {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;

        let url = `/data/export/${format}?`;
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}`;

        window.open(API_URL + url, '_blank');
    }

    async function importData() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];

        if (!file) {
            showError('Выберите файл для импорта');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        showLoading(true);
        try {
            const response = await fetch(API_URL + '/data/import', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Import failed');

            const result = await response.json();

            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            document.getElementById('importForm').reset();

            if (result.errors && result.errors.length > 0) {
                showError(`Импортировано ${result.imported} из ${result.total}. Ошибки: ${result.errors.join(', ')}`);
            } else {
                showSuccess(`Импортировано ${result.imported} транзакций`);
            }

            loadTransactions();
            loadDashboard();
        } catch (error) {
            showError('Ошибка при импорте данных');
        } finally {
            showLoading(false);
        }
    }

    // Modal functions
    function showAddTransactionModal() {
        const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
        updateTransactionForm();
        selectedTags = [];
        updateTagsSelect();
        // Set the selected date from calendar using safe formatting
        document.getElementById('date').value = formatDateForInput(currentSelectedDate);
        modal.show();
    }

    function showImportModal() {
        const modal = new bootstrap.Modal(document.getElementById('importModal'));
        modal.show();
    }

    function showAddAccountModal() {
        const modal = new bootstrap.Modal(document.getElementById('addAccountModal'));
        modal.show();
    }

    function showAddCategoryModal() {
        const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
        // Load parent categories
        const parentSelect = document.getElementById('parentCategory');
        const parentCategories = categories.filter(c => c.level === 0);
        parentSelect.innerHTML = '<option value="">Нет (основная категория)</option>' +
            parentCategories.map(c =>
                `<option value="${c.id}">${c.icon || '📁'} ${c.name}</option>`
            ).join('');
        modal.show();
    }

    function showAddBudgetModal() {
        const modal = new bootstrap.Modal(document.getElementById('addBudgetModal'));
        // Load expense categories
        const categorySelect = document.getElementById('budgetCategory');
        const expenseCategories = categories.filter(c => c.type === 'expense' && c.level === 0);
        categorySelect.innerHTML = '<option value="">Выберите категорию</option>' +
            expenseCategories.map(c =>
                `<option value="${c.id}">${c.icon || '📁'} ${c.name}</option>`
            ).join('');
        modal.show();
    }

    function showAddTagModal() {
        const modal = new bootstrap.Modal(document.getElementById('addTagModal'));
        modal.show();
    }

    function showAddGoalModal() {
        const modal = new bootstrap.Modal(document.getElementById('addGoalModal'));
        modal.show();
    }

    function showAddRecurringModal() {
        const modal = new bootstrap.Modal(document.getElementById('addRecurringModal'));
        updateRecurringForm();
        // Set the selected date from calendar using safe formatting
        document.getElementById('recurringStartDate').value = formatDateForInput(currentSelectedDate);
        modal.show();
    }

    // Utility functions
    async function fetchAPI(endpoint) {
        const response = await fetch(API_URL + endpoint);
        if (!response.ok) throw new Error('API Error');
        return response.json();
    }

    async function postAPI(endpoint, data) {
        const response = await fetch(API_URL + endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error('API Error');
        return response.json();
    }

    async function putAPI(endpoint, data) {
        const response = await fetch(API_URL + endpoint, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error('API Error');
        return response.json();
    }

    async function deleteAPI(endpoint) {
        const response = await fetch(API_URL + endpoint, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        if (!response.ok) throw new Error('API Error');
        return response.json();
    }

    function formatMoney(amount, currency = 'KZT') {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount || 0);
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    }

    function getAccountName(transaction) {
        if (transaction.type === 'expense') return transaction.account_from_name || '';
        if (transaction.type === 'income') return transaction.account_to_name || '';
        if (transaction.type === 'transfer') return `${transaction.account_from_name} → ${transaction.account_to_name}`;
        return '';
    }

    function getAccountTypeName(type) {
        const types = {
            'cash': 'Наличные',
            'debit_card': 'Дебетовая карта',
            'credit_card': 'Кредитная карта',
            'savings': 'Сберегательный счет',
            'investment': 'Инвестиционный счет'
        };
        return types[type] || type;
    }

    function getFrequencyName(frequency) {
        const frequencies = {
            'daily': 'Ежедневно',
            'weekly': 'Еженедельно',
            'monthly': 'Ежемесячно',
            'quarterly': 'Ежеквартально',
            'yearly': 'Ежегодно'
        };
        return frequencies[frequency] || frequency;
    }

    function getMonthsWord(count) {
        const lastDigit = count % 10;
        const lastTwoDigits = count % 100;

        if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
            return 'месяцев';
        }

        if (lastDigit === 1) {
            return 'месяц';
        } else if (lastDigit >= 2 && lastDigit <= 4) {
            return 'месяца';
        } else {
            return 'месяцев';
        }
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').classList.toggle('d-none', !show);
    }

    function showSuccess(message) {
        const toastEl = document.getElementById('successToast');
        document.getElementById('successMessage').textContent = message;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    function showError(message) {
        const toastEl = document.getElementById('errorToast');
        document.getElementById('errorMessage').textContent = message;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>
</body>
</html>>